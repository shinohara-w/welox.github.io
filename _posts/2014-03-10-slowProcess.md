---
layout: post
title: 遅い処理をきちんと解析してみる
date: 2014-03-10
category : yamamichi
tags : [slow, local]
---

### その前に
この解析にはデバッガが導入されたローカル環境が必要です。<br />
詳しい解析方法はデバッガによって異なるので、ここでは割愛します。<br />

### 解析結果
解析結果を出力して整形したりすると、このようになりました。<br />
![解析結果その１](/images/yamamichi/slowProcess01.jpg)
<br />
見るべき箇所を順番に説明します。<br />
・処理にかかった時間<br />
　右上に、1466 different functions called in 13102 millisecondsと書かれています。<br />
　これが、処理にかかった時間です。ミリ秒で記載されているので注意。約１３秒ですね。<br />
　ローカル環境はスペックが残念なので、非常に時間がかかっています。<br />
　本番環境ではもっと早いはずなので、ここで計測した時間については、色々対策を行った後の時間との比較対象として使うことになります。<br />
　もちろん、複数回計測して平均を取った方がより良いデータになります。<br />

・処理時間の分類(タイプ毎)<br />
　右上のバーを見てください。青、緑、灰色、オレンジにそれぞれ色分けされています。<br />
　ざっくり説明すると以下のような意味です。<br />
　<font color = "blue">青</font>：php<br />
　<font color = "green">緑</font>：フレームワーク<br />
　<font color = "gray">灰</font>：requireなど<br />
　<font color = "orange">オレンジ</font>：main関数など<br />
  <br />
　<font color = "gray">灰</font>と<font color = "orange">オレンジ</font>は微々たるものなので無視します。<br />
　<font color = "green">緑</font>はフレームワーク、ここではsymfonyの実行に相当します。<br />
　このバーは処理全体を表しているので、<font color = "red">全体の60%くらいはsymfonyの処理を行っている</font>という意味になります。<br />
　symfonyは重いと言われるのはこの辺が原因でしょうか。<br />
　ここについては改善しようがないので放置です。<br />
  <br />
　問題は<font color = "blue">青</font>の部分です。<br />
　ここは改善の余地があります。<br />
　全体の40%くらいなので、だいたい５秒くらいはここに時間がかかっている計算になります。<br />
　では、<font color = "red">この中で一番時間がかかっている処理は何なのか</font>を見てみましょう。<br />

・処理時間の分類(関数毎)<br />
　画像の大半を占めるテーブル部分を見てください。<br />
　Function, Invocation Count, Total Selef Cost, Total Inclusive Costの４つのカラムがあります。<br />
　ここで注目するべきは、<font color = "red">3つ目のTotal Self Cost</font>です。<br />
　ざっくり言えば、そのFunctionが全体の何％処理時間を使っているかを表します。<br />
　なお、このテーブルはデフォルトではこのカラムの降順にソートされています。<br />
　<br />
　一番上のレコードは、この値が24.57となっています。つまり、25%くらいはこの処理に時間がかかっているということです。<br />
　また、このレコードの左端には<font color = "blue">青い丸</font>がついています。<br />
　これは、前述の分類でいう<font color = "blue">青</font>の部分に相当する処理だと言う事です。<br />
　そしてFunction名はphp::PDO->query。つまり、クエリ実行に非常に時間がかかっているということが読み取れます。<br />
　<br />
　ということでまとめると、<br />
　・全体で約13秒かかっている<br />
　・うち６割はsymfonyの処理であり、これは改善が難しい<br />
　・残り４割(のうちの<font color = "blue">青い部分</font>)は改善の余地がある。<br />
　・全体で一番時間がかかっている処理は、テーブルの一番上のレコードで、php::PDO->queryが25%。<br />
　・php::PDO->queryは<font color = "blue">青丸</font>がついているので改善可能だと判断できる。<br />
　　また、青い部分は全体の４０％、php::PDO->queryは全体の２５％ということから、<font color = "red">青い部分の半分以上はphp::PDO->queryが原因だと言えます</font><br />
　・以上より、<font color = "red">この処理を軽くするには、クエリチューニングが効果的であると判断できます</font><br />

### 解析結果その２
さらなる解析のために、上記結果を図にします。<br />
こちらをご覧ください(かなり大きい画像なので、一部抜粋です)<br />
![解析結果その2](/images/yamamichi/slowProcess02.jpg)
<br />
<font color = "red">赤い箇所が遅い処理です</font><br />
PDO->queryが2種類あります。これは上を辿っていけば分かりますが、クエリが２種類実行されているからです(正確にはここに表示されていないだけでもっと実行されてますが)<br />
片方は真っ赤で2411ms, もう片方はそこそこ赤くて806msです。<br />
よって、<font color = "red">まずは2411msかかっているクエリへの対処、次いで806msかかっているクエリの対処という順序で対策するべき</font>だと分かります。<br />
<br />


### 最後に
ローカル環境＋デバッガの組み合わせは非常に強力なので是非試してみてください。<br />
今回はプロファイル機能だけを紹介しましたが、他にも色んな機能や利点があります。<br />
ただし、皆様ご存知の通り、環境構築がスムーズに行くことはまず滅多にありません。構築するなら少しずつ進めていく事をお勧めします。<br />
なお、macで構築する場合にはアドバイスできると思うのでチャットでも投げてください。<br />







